# 16__PIPE_FOCUS_LOOP

SCOPE: Universe Engine (UE_V2)  
DOC_TYPE: PIPE / PROTOCOL  
UID: UE.V2.PIPE.FOCUS_LOOP.001  
VERSION: 1.1.0  
STATUS: ACTIVE  
MODE: REPO (USAGE-ONLY, NO-EDIT)  
NAV_RULE: Use RAW links only  
PURPOSE: Механизм “сжать хаос” в 1–2 экрана, выбрать одну ветку и вернуться в STEP-RUN без засора контекста.

---

## [M] INTENT
FOCUS-LOOP включается, когда:
- задача распухла (много веток, много деталей, много допущений);
- нельзя задавать пачку вопросов;
- нужен детерминированный выбор пути;
- качество падает из-за шума.

Цель FOCUS-LOOP:
- сузить проблему до 1 фокуса;
- зафиксировать решения/отбраковки токеном;
- определить минимальный следующий шаг;
- вернуть управление в STEP-RUN.

---

## [M] WHEN TO TRIGGER (CANON)
Триггеры включения:
F1) текст > ~2 экрана и нет ясного “что дальше”  
F2) > 3 параллельных варианта решения  
F3) появились конфликты правил/ограничений/входов  
F4) появились “догадки” вместо RAW/маркерных правил  
F5) пользователь дал “го” много раз, а прогресс не детерминирован  
F6) требуется выбор стиля/формата/направления без лишних вопросов

---

## [M] HARD RULES (ANTI-NOISE)
R1) FOCUS-LOOP — короткий. 1–2 итерации максимум до возврата в основной PIPE.  
R2) Никаких массовых загрузок. Только 1 доменный IDX + 1–3 файла.  
R3) В конце FOCUS-LOOP обязателен `FOCUS_TOKEN`.  
R4) FOCUS-LOOP всегда заканчивается `USER_PROMPT = "го"`.  
R5) Результат должен быть “выполним за следующий STEP”.

---

## [M] LOOP SHAPE (CANON)
FOCUS-LOOP состоит из 4 фаз:

### L0) SNAPSHOT
- Что сейчас делаем (1 строка).
- Где застряли (1 строка).
- Что мешает (1–3 буллета).

### L1) REDUCE
- Сжать до 1 фокуса:
  - “Самая важная цель” (1 строка)
  - “Главная преграда” (1 строка)
  - “Что точно НЕ делаем сейчас” (3–7 буллетов)

### L2) DECIDE
- Выбрать одну ветку детерминированно:
  - Вариант A/B/C (по 1 строке)
  - Критерии выбора (3–5 буллетов)
  - Выбор (1 строка) + почему (1–3 буллета)

### L3) RETURN
- Вернуться в STEP-RUN:
  - Следующий STEP_ID
  - Минимальные входы на шаг
  - Что будет токеном следующего шага

---

## [M] DETERMINISTIC CHOICE RULE
Если данных мало и нельзя спрашивать:
- выбирай “минимально-рискованный вариант”, который:
  - соответствует ограничениям,
  - требует меньше допущений,
  - быстрее даёт проверяемый результат,
  - легче чинится.

Если варианты равны:
- выбирай вариант с самым простым “откатом” (reversible).

---

## [M] FOCUS_TOKEN (CANON)
FOCUS_TOKEN обязателен и должен быть компактным:

FOCUS_TOKEN:
- FOCUS: (1 строка)
- BLOCKER: (1 строка)
- OPTIONS: (A/B/C по 1 строке)
- CRITERIA: (3–5 буллетов)
- DECISION: (1 строка)
- DROPPED: (что отбросили сейчас, 3–9 буллетов)
- NEXT_STEP: (STEP_ID + цель)
- NOTES: (опционально, 0–3 буллета)

---

## [M] INSERT POINTS (WHERE IT CAN APPEAR)
FOCUS-LOOP можно вставлять:
- внутри любого PIPE шага,
- между STEP_01 (PLAN) и STEP_03 (DRAFT),
- перед REVIEW если непонятно что проверять,
- после QA_FAIL чтобы выбрать минимальную правку.

---

## [M] FAILURE MODES
### REWORK
Если после FOCUS-LOOP всё ещё 3+ ветки:
- значит REDUCE не сработал,
- повторить L1–L2 один раз,
- иначе STOP как “не хватает входов”.

### STOP
Если невозможно выбрать без критических данных:
- указать, какие 1–2 входа обязательны,
- ждать ввод.

---

## [M] GATES
PASS если:
- создан FOCUS_TOKEN,
- выбран 1 путь,
- определён NEXT_STEP,
- конец — "го".

REWORK если:
- осталось > 2 активных пути,
- NEXT_STEP не исполним,
- FOCUS_TOKEN распух.

STOP если:
- критически не хватает входов для выбора,
- выбор будет чистой фантазией.

---

## [M] OUTPUT FORMAT (STRICT)
1) `FOCUS_LOOP` (кратко: где застряли)  
2) `FOCUS_TOKEN` (как выше)  
3) `RETURN_TO_STEP_RUN` (какой STEP_ID дальше)  
4) `USER_PROMPT`: го
