# 15__PIPE_STEP_RUN

SCOPE: Universe Engine (UE_V2)  
DOC_TYPE: PIPE / PROTOCOL  
UID: UE.V2.PIPE.STEP_RUN.001  
VERSION: 1.1.0  
STATUS: ACTIVE  
MODE: REPO (USAGE-ONLY, NO-EDIT)  
NAV_RULE: Use RAW links only  
PURPOSE: Как любой PIPE исполняется в режиме STEP-RUN (один шаг за раз + "го") без засора контекста и с фиксацией токенов.

---

## [M] INTENT
STEP-RUN нужен, чтобы:
- выполнять любую сложную задачу серией коротких прогонов;
- удерживать контекст лёгким (без “простыней” справки);
- фиксировать решения и артефакты токенами;
- давать пользователю контроль темпа через "го";
- гарантировать, что PIPE не “перепрыгивает” проверки и упаковку результата.

---

## [M] SCOPE
Протокол применяется:
- ко всем PIPE внутри UE_V2 (DEFAULT и доменные);
- к любому EXEC_MODE, где требуется “шаг → фиксация → подтверждение → следующий шаг”.

Не заменяет доменные правила PIPE.  
STEP-RUN — это **каркас исполнения**.

---

## [M] DEFINITIONS
- **STEP** — минимальный атом выполнения. Один логический кусок работы.
- **STEP_ID** — `STEP_00`, `STEP_01`, ... (монотонно, без пропусков).
- **USER_PROMPT** — обязательный “якорь” конца шага: пользователь отвечает `"го"`.
- **TOKEN** — минимальная фиксируемая сущность результата шага (решение/план/черновик/отчёт/дельта/пак).
- **ARCHIVE** — место/механизм хранения токенов так, чтобы их можно было восстановить без перегруза контекста.

---

## [M] CORE RULES (CANON)
R1) PIPE исполняется **последовательностью STEP_ID**: `STEP_00`, `STEP_01`... :contentReference[oaicite:1]{index=1}  
R2) Каждый STEP **обязан завершаться** `USER_PROMPT = "го"`. :contentReference[oaicite:2]{index=2}  
R3) Каждый STEP **обязан создать минимум 1 STEP_TOKEN** (ссылка: STD/15). :contentReference[oaicite:3]{index=3}  
R4) STEP держит **только текущий рабочий контекст**, а всё “тяжёлое” — через ссылки на ARCHIVE токенов. :contentReference[oaicite:4]{index=4}  
R5) Любой PIPE может вставлять **FOCUS-LOOP** на любой стадии (ссылка: `16__PIPE_FOCUS_LOOP`). :contentReference[oaicite:5]{index=5}  

Дополнительные (усиление стабильности):
R6) **Один шаг — одна цель.** Нельзя смешивать intake+plan+draft в одном STEP.  
R7) **Не расширять загрузку.** Если нужен новый файл/правило — добавь его только в текущий шаг и только минимум.  
R8) **Каждый шаг должен быть проверяемым.** Пользователь должен понимать: что сделано и что будет дальше.  
R9) **Никаких “тихих” решений.** Любое решение фиксируется в TOKEN (или явно помечается как TODO/ASSUMPTION).  

---

## [M] STEP LAYOUT (CANON)
Базовый порядок шагов (дефолтный скелет): :contentReference[oaicite:6]{index=6}  

### STEP_00 — INTAKE
Цель: зафиксировать исходные вводные без шума.  
Выход (минимум):
- `BRIEF_TOKEN`
- `ROUTE_TOKEN` (если он уже сформирован системой выше, здесь — только подтверждение/ссылка)

### STEP_01 — PLAN
Цель: план и бюджеты по контексту.  
Выход:
- `PLAN_TOKEN` (stages, budgets, coverage, participants)

### STEP_02 — KB
Цель: какие правила/ограничения/запреты применяем.  
Выход:
- `KB_TOKEN` (scope + rules + do_not)

### STEP_03 — OPTIONS / DRAFT
Цель: вариантность или первый черновик.  
Выход:
- `OPTIONS_TOKEN` **или** `DRAFT_v1` (по типу задачи)

### STEP_04 — REVIEW
Цель: контроль качества (CTL/VAL/QA).  
Выход:
- `REPORT_TOKEN` (что ок, что нет, риски, где провал)

### STEP_05 — FIX
Цель: точечная правка по отчёту.  
Выход:
- `DELTA_TOKEN` (v2)

### STEP_06 — REVIEW_2 (optional)
Цель: spot-check после правок (только если нужно).  
Выход:
- `REPORT_TOKEN(QA/VAL)` (короткий)

### STEP_07 — PACK + SIGNOFF
Цель: упаковать результат в финальный артефакт.  
Выход:
- `PACK_TOKEN`
- `BASELINE_TOKEN`

---

## [M] TOKEN DISCIPLINE (ANTI-NOISE)
T1) **Один STEP = 1–3 токена максимум.**  
T2) Если шаг “раздулся” — включай FOCUS-LOOP и дроби.  
T3) В каждом токене:
- краткий заголовок,
- 3–9 буллетов сути,
- “что дальше” (если применимо),
- “что НЕ делали” (если есть риск ожиданий).

T4) Токены — это “память”, а не текст ради текста.

---

## [M] STEP OUTPUT FORMAT (CANON)
Каждый шаг ассистента должен иметь структуру:

1) `STEP_ID` + краткая цель  
2) `DONE` — что сделано (буллеты)  
3) `TOKENS` — какие токены созданы (названия)  
4) `NEXT` — что будет в следующем шаге  
5) `USER_PROMPT` — **строго**: `го`

---

## [M] WHEN TO INSERT FOCUS-LOOP
Вставлять FOCUS-LOOP, если:
- стало > 2 экрана текста без токенов;
- появилось > 3 параллельных ветки решения;
- нужны уточнения, но нельзя спрашивать много;
- качество упало (много допущений).

FOCUS-LOOP обязан завершиться:
- `FOCUS_TOKEN` (что выбрали / что отбросили / почему),
- возвратом в основной STEP_LAYOUT.

---

## [M] ERROR MODES
### REWORK
Триггеры:
- шаги слились в “комок”;
- нет токенов;
- нет “го” в конце.

Действие:
- откат к последнему валидному токену,
- дробление шага,
- повтор.

### STOP
Триггеры:
- нет `USER_PROMPT = "го"` в конце шага; :contentReference[oaicite:7]{index=7}  
- отсутствуют обязательные входы на шаге (например, нет BRIEF для INTAKE).

Действие:
- остановиться,
- сообщить, чего не хватает,
- ждать ввод.

---

## [M] GATES
PASS если: :contentReference[oaicite:8]{index=8}  
- соблюдён порядок (или указано осознанное отклонение),
- есть токены,
- каждый шаг закрыт "го".

REWORK если: :contentReference[oaicite:9]{index=9}  
- шаги сливаются в один большой блок,
- токены не создаются или нечитабельны.

STOP если: :contentReference[oaicite:10]{index=10}  
- нет USER_PROMPT "го" в конце шага,
- отсутствуют обязательные входы.

---

## [M] CHANGELOG
- 1.1.0: расширен протокол: определения, дисциплина токенов, формат вывода шага, anti-noise правила, условия FOCUS-LOOP, режимы ошибок, усиленные gates.
