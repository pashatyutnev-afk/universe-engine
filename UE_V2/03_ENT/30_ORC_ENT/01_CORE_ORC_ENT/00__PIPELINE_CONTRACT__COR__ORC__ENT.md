FILE: UE_V2/03_ENT/30_ORC_ENT/01_CORE_ORC_ENT/00__PIPELINE_CONTRACT__COR__ORC__ENT.md
SCOPE: UE_V2 / 03_ENT / 30_ORC_ENT / 01_CORE_ORC_ENT
DOC_TYPE: PIPELINE_CONTRACT
DOMAIN: COR_ORC_ENT
UID: UE.V2.ENT.PIPE.COR_ORC_ENT.001
VERSION: 1.0.0
STATUS: ACTIVE
MODE: REPO (USAGE-ONLY, NO-EDIT)
CREATED: 2026-02-02
UPDATED: 2026-02-02
OWNER: ORC_ENT
NAV_RULE: Contract has no RAW

---

## [M] PURPOSE
CORE PIPELINE_CONTRACT — корневой раннер оркестрации.
Принимает запрос, определяет домен, строит ROUTE_TOKEN, выбирает пайп, диспетчеризует шаги, логирует и пакует результат.
RAW не хранит: всё через KEY -> INDEX_MANIFEST -> open.

## [M] HARD_RULES
- RAW запрещён внутри CONTRACT.
- Роутинг и загрузка только через KEYS и INDEX_MANIFEST.
- STEP-RUN: один шаг = одна пачка действий, затем NEXT_PROMPT.
- Минимальные открытия: только то, что нужно в текущем шаге.
- MODE REPO: никаких правок репозитория.
- Любой выход: NEXT_PROMPT: "го" или FAIL_CODE.

## [M] REQUIRED_KEYS (must exist in INDEX_MANIFEST of this realm)
- INDEX_MANIFEST
- PIPELINE_CONTRACT
- COR.TASK_INTAKE
- COR.DOMAIN_DETECTOR
- COR.ROUTE_TOKEN_BUILDER
- COR.NAV_SENTINEL
- COR.REG_SENTINEL
- COR.XREF_SENTINEL
- COR.KB_SENTINEL
- COR.PIPE_SELECTOR
- COR.PIPE_DISPATCHER
- COR.STEP_RUN_CONTROLLER
- COR.FOCUS_LOOP_CONTROLLER
- COR.GATEKEEPER
- COR.LOGGER
- COR.FAIL_HANDLER
- COR.RELEASE_PACKAGER
- LEGACY.NARRATIVE_ORC_ENG
- LEGACY.CHARACTER_ORC_ENG
- LEGACY.WORLD_ORC_ENG
- LEGACY.PRODUCTION_ORC_ENG
- LEGACY.PIPELINE_ORC_ENG

## [M] CONTRACT_HEADER
- REALM_ID: UE_V2/03_ENT/30_ORC_ENT/01_CORE_ORC_ENT
- DOMAIN: COR_ORC_ENT
- ARTIFACT_TYPES: [ROUTE_TOKEN, RUN_LOG, DECISION_LOG, OUTPUT_PACK]
- DEFAULT_MODE: RELEASE_READY

## [M] EXEC_MODEL
1) Resolve INDEX_MANIFEST via KEY: INDEX_MANIFEST
2) Validate REQUIRED_KEYS exist
3) Run S0..S3 (STEP-RUN), keep ROUTE_TOKEN stable
4) Emit: RUN_LOG + (optional) DECISION_LOG + OUTPUT_PACK

## [M] STEP-RUN (canonical)
- STEP: S
  GOAL:
  INPUTS: []
  TARGETS: []
  ACTIONS:
    -
  OUTPUTS: []
  CHECKS: []
  FAIL:
  NEXT: "го"

## [M] STEPS (core)
- STEP: S0
  GOAL: Task intake and normalization
  INPUTS: [TASK_TEXT, MODE_HINT?]
  TARGETS: [COR.TASK_INTAKE]
  ACTIONS:
    - Build TASK_TOKEN (intent, constraints, user goals)
    - Set EXEC_MODE
  OUTPUTS: [TASK_TOKEN, EXEC_MODE]
  CHECKS: [TASK_PRESENT]
  FAIL: UE.FAIL.INPUT_ABSENT
  NEXT: "го"

- STEP: S1
  GOAL: Domain detection + build route token
  INPUTS: [TASK_TOKEN, EXEC_MODE]
  TARGETS: [COR.DOMAIN_DETECTOR, COR.ROUTE_TOKEN_BUILDER]
  ACTIONS:
    - Detect DOMAIN_TARGET (e.g. MUS/VID/WEB/DOC/RCH/GVN/MET)
    - Build ROUTE_TOKEN (TARGET_REALM_KEYS, WORK_SET_KEYS, LOAD_ORDER, PIPE_CANDIDATES)
  OUTPUTS: [ROUTE_TOKEN]
  CHECKS: [DOMAIN_FOUND, ROUTE_BUILT]
  FAIL: UE.FAIL.ROUTE_UNRESOLVED
  NEXT: "го"

- STEP: S2
  GOAL: Sentinels + pipe selection + dispatch
  INPUTS: [ROUTE_TOKEN, EXEC_MODE]
  TARGETS: [COR.NAV_SENTINEL, COR.REG_SENTINEL, COR.XREF_SENTINEL, COR.KB_SENTINEL, COR.PIPE_SELECTOR, COR.PIPE_DISPATCHER]
  ACTIONS:
    - Enforce RAW-only navigation (NAV_SENTINEL)
    - Validate required registers/log hooks (REG_SENTINEL)
    - Validate cross-realm boundaries (XREF_SENTINEL)
    - Enforce KB scope boundaries (KB_SENTINEL)
    - Select PIPE_KEY (PIPE_SELECTOR)
    - Dispatch into target PIPELINE_CONTRACT (PIPE_DISPATCHER)
  OUTPUTS: [DISPATCH_TOKEN, PIPE_KEY]
  CHECKS: [SENTINELS_PASS, PIPE_SELECTED]
  FAIL: UE.FAIL.GATE_FAIL
  NEXT: "го"

- STEP: S3
  GOAL: Control step cadence, focus loop, gating, logs and release pack
  INPUTS: [DISPATCH_TOKEN, PIPE_KEY, EXEC_MODE]
  TARGETS: [COR.STEP_RUN_CONTROLLER, COR.FOCUS_LOOP_CONTROLLER, COR.GATEKEEPER, COR.LOGGER, COR.RELEASE_PACKAGER]
  ACTIONS:
    - Maintain step cadence S0..Sn for called pipe (STEP_RUN_CONTROLLER)
    - Prevent drift, keep scope stable (FOCUS_LOOP_CONTROLLER)
    - Final PASS/FAIL decision (GATEKEEPER)
    - Emit RUN_LOG / DECISION_LOG (LOGGER)
    - Package OUTPUT_PACK (RELEASE_PACKAGER)
  OUTPUTS: [OUTPUT_PACK, RUN_LOG, DECISION_LOG?]
  CHECKS: [FINAL_GATE]
  FAIL: UE.FAIL.GATE_FAIL
  NEXT: "го"

## [M] FAIL_CODES (core)
- UE.FAIL.INPUT_ABSENT
- UE.FAIL.ROUTE_UNRESOLVED
- UE.FAIL.RULE_VIOLATION
- UE.FAIL.GATE_FAIL
- UE.FAIL.APPROVAL_REQUIRED
- UE.FAIL.LOG_MISSING

## [M] CHANGELOG
- 2026-02-02: v1.0.0 init
