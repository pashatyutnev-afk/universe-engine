FILE: UE_V2/03_ENT/40_CTL_ENT/10_MUSIC_CONTROLLERS_CTL_ENT/00__PIPELINE_CONTRACT__MUS__CTL__ENT.md
SCOPE: UE_V2 / 03_ENT / 40_CTL_ENT / 10_MUSIC_CONTROLLERS_CTL_ENT
DOC_TYPE: PIPELINE_CONTRACT
DOMAIN: MUS_CTL_ENT
UID: UE.V2.ENT.PIPE.MUS_CTL_ENT.001
VERSION: 1.0.0
STATUS: ACTIVE
MODE: REPO (USAGE-ONLY, NO-EDIT)
CREATED: 2026-02-02
UPDATED: 2026-02-02
OWNER: CTL_ENT
NAV_RULE: Contract has no RAW

---

## [M] PURPOSE
PIPELINE_CONTRACT — роутер музыкальных контроллеров.
Определяет: какие CTL обязательны, какой порядок, и как разрешать конфликты решений.
RAW не хранит: всё через KEY и INDEX_MANIFEST.

## [M] HARD_RULES
- RAW запрещён внутри CONTRACT.
- Все ссылки: только KEYS.
- MODE REPO: никаких правок репозитория.
- Выход: CTL_CHAIN_PLAN (KEYS) + PRIORITY_ORDER + CONFLICT_RULES.

## [M] REQUIRED_KEYS
- INDEX_MANIFEST
- PIPELINE_CONTRACT
- CTL.MUS.POET_PD_POLICY
- CTL.MUS.FINGERPRINT_COLLISION_THRESHOLDS
- CTL.MUS.QUALITY_GATES
- CTL.MUS.PROMPT_CONTRACT

## [M] PRIORITY_ORDER (highest first)
1) CTL.MUS.POET_PD_POLICY
2) CTL.MUS.FINGERPRINT_COLLISION_THRESHOLDS
3) CTL.MUS.QUALITY_GATES
4) CTL.MUS.PROMPT_CONTRACT
5) CTL.MUS.DURATION_POLICY
6) CTL.MUS.STEP_BUDGET
7) CTL.MUS.VARIANT_POLICY
8) CTL.MUS.RELEASE_VARIANTS
9) CTL.MUS.SYNTHESIS_MERGE_POLICY
10) CTL.MUS.CREDITS_METADATA_POLICY
11) CTL.MUS.CATALOG_MEMORY
12) CTL.MUS.AUDIENCE_SEGMENTS
13) CTL.MUS.NEGATIVE_SPEC_LIBRARY
14) CTL.MUS.SUNO_PHRASEBOOK
15) CTL.MUS.UDIO_PHRASEBOOK
16) CTL.MUS.UGC_VIRAL_RULESET (conditional, only if UGC/viral target)

## [M] CONFLICT_RULES
- FAIL dominates everything (stop, return REQUIRED_FIXES).
- ASK dominates PASS/WARN (request minimal required input).
- WARN can pass through, but REQUIRED_FIXES must be returned.
- PASS is only when no higher-severity decision exists.

## [M] DEFAULT_CHAIN_PLAN (keys)
- ALWAYS:
  - CTL.MUS.POET_PD_POLICY
  - CTL.MUS.FINGERPRINT_COLLISION_THRESHOLDS
  - CTL.MUS.QUALITY_GATES
  - CTL.MUS.PROMPT_CONTRACT
- THEN (as applicable):
  - CTL.MUS.DURATION_POLICY
  - CTL.MUS.STEP_BUDGET
  - CTL.MUS.VARIANT_POLICY
  - CTL.MUS.RELEASE_VARIANTS
  - CTL.MUS.SYNTHESIS_MERGE_POLICY
  - CTL.MUS.CREDITS_METADATA_POLICY
  - CTL.MUS.CATALOG_MEMORY
  - CTL.MUS.AUDIENCE_SEGMENTS
  - CTL.MUS.NEGATIVE_SPEC_LIBRARY
  - CTL.MUS.SUNO_PHRASEBOOK
  - CTL.MUS.UDIO_PHRASEBOOK
  - CTL.MUS.UGC_VIRAL_RULESET (if target indicates shortform/ugc/viral)

## [M] STEP-RUN
- STEP: S0
  GOAL: Build chain keys from task token
  INPUTS: [MUS_BRIEF, STYLE_ROUTE_TOKEN?]
  TARGETS: [INDEX_MANIFEST]
  ACTIONS:
    - Select conditional controllers based on MUS_BRIEF (ugc or not)
    - Output CTL_CHAIN_PLAN (KEYS only)
  OUTPUTS: [CTL_CHAIN_PLAN]
  CHECKS: [REQUIRED_KEYS_PRESENT]
  FAIL: UE.FAIL.MISSING_KEY
  NEXT: "го"

- STEP: S1
  GOAL: Execute chain in priority order and resolve conflicts
  INPUTS: [CTL_CHAIN_PLAN, CONTEXT_TOKENS]
  TARGETS: []
  ACTIONS:
    - Apply CTLs in PRIORITY_ORDER
    - Aggregate decisions using CONFLICT_RULES
  OUTPUTS: [CTL_AGG_DECISION, REQUIRED_FIXES, FINDINGS]
  CHECKS: [DECISION_PRODUCED]
  FAIL: UE.FAIL.GATE_FAIL
  NEXT: "го"

## [M] FAIL_CODES
- UE.FAIL.MISSING_KEY
- UE.FAIL.GATE_FAIL
- UE.FAIL.RULE_VIOLATION
